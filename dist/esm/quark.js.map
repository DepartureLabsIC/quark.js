{"version":3,"file":"quark.js","sources":["../../index.js"],"sourcesContent":["let quarkWindow\nlet basket = []\nconst ALLOWED_AUTH_PROVIDERS = [\"ii\"]\nconst ALLOWED_VALUE_TYPES = [\"ICP\"]\n\n/**\n * NotifyObject\n *\n * Used to produce a Candid func that is called when the checkout\n * has been confirmed on the Quark website. From there on out it is\n * up to the merchant to process all the bought items by the end-user.\n *\n * More info:\n * https://smartcontracts.org/docs/candid-guide/candid-types.html#type-func\n *\n * @typedef {Object} NotifyObject\n * @property {string} principalId the ID of the merchant's canister\n * @property {string} methodName the name of the exposed method\n */\n\n/**\n * InitConfig\n *\n * A valid config to initialize Quark on the merchant's website.\n * @typedef {Object} InitConfig\n * @property {string} authProvider - Used to ensure the correct\n * auth mechanism when the user is redirected to the Quark website\n * to proceed the checkout.\n * @property {string} payee - A canister ID where the funds will\n * be sent to upon a successful checkout\n * @property {string} domain - The domain of the Quark website\n * @property {NotifyObject} - An exposed canister method that\n * belongs to the merchant that is called when Quark successfully\n * confirms the checkout.\n */\n\n/**\n * init - Initialize quark.js\n *\n * When called the configuration passed as a parameter is first\n * validated. When validated, we're attaching an eventListener\n * to the window scope. The eventListener will execute a handler\n * upon receiving an incoming message. When this message comes from\n * the Quark website it will execute code to ensure communication\n * between quark.js and the Quark website.\n *\n * There are two types of incoming messages on the quark.js-side:\n * - `checkoutLoaded`: this message will be dispatched once the Quark\n * checkout page was opened in another tab. Upon receiving this\n * message we will send all the necessary data to the opened tab,\n * such as basket, payee, etc. using a window.postMessage\n * MessageEvent with the type `basketUpdate`.\n * - `checkoutComplete`: this is sent to our listener when the user\n * has confirmed the checkout on the Quark website. Upon receiving\n * a message with this type, we will call the `callback` Function\n * that the user passed inside the init() config and it's up to\n * the merchant to take it from there.\n *\n * Also, there is one type of outgoing message going from the\n * quark.js-side to the Quark-side:\n * - `basketUpdate`: When opened in the end-user's browser, the\n * Checkout page on the Quark website will listen for this\n * particular message to update the contents of the checkout\n * and calculate the total sum of the transaction to display\n * this to the user to confirm.\n *\n * checkout(basket);\n *\n * @param {InitConfig} config\n * @returns {void}\n */\nconst init = config => {\n  validateConfig(config)\n  window.addEventListener(\n    \"message\",\n    function (event) {\n      if (event.origin !== config.domain) return // DANGER ZONE\n      const eventData = JSON.parse(event.data)\n      if (![\"checkoutLoaded\", \"checkoutComplete\"].includes(eventData.type))\n        return\n      if (eventData.type === \"checkoutLoaded\") {\n        const message = JSON.stringify(\n          {\n            type: \"basketUpdate\",\n            basket,\n            origin,\n            notify: config.notify,\n            payee: config.payee,\n            authProvider: config.authProvider,\n          },\n          (_key, value) => (typeof value === \"bigint\" ? Number(value) : value),\n        )\n        quarkWindow.postMessage(message, config.domain)\n      } else if (\"checkoutComplete\") {\n        config.callback(eventData)\n      }\n    },\n    false,\n  )\n\n  /**\n   * getTotal - Utility Function to calculate the total sum of checkout items\n   *\n   * @param {Array.<BasketItem>} basket\n   * @returns {number}\n   */\n  function getTotal(basket = []) {\n    let total = 0\n    basket.forEach(v => (total += Number(v.value)))\n    return total\n  }\n\n  /**\n   * validateConfig - Utility Function to validate the `config` param init()\n   *\n   * @param {InitConfig} config\n   * @returns {void}\n   */\n  function validateConfig(config) {\n    if (!config.payee) throw new Error(\"The field `payee` is required\")\n    if (!config.domain) throw new Error(\"The field `domain` is required\")\n    if (!config.notify) throw new Error(\"The field `notify` is required\")\n    if (!config.authProvider)\n      throw new Error(\"The field `authProvider` is required\")\n    if (typeof config.payee !== \"string\")\n      throw new Error(\"The field `payee` must be of type 'string'\")\n    if (typeof config.domain !== \"string\")\n      throw new Error(\"The field `domain` must be of type 'string'\")\n    if (typeof config.authProvider !== \"string\")\n      throw new Error(\"The field `authProvider` must be of type 'string'\")\n    if (typeof config.notify !== \"object\")\n      throw new Error(\"The field `notify` must be of type 'object'\")\n    if (!config.notify.principalId || !config.notify.methodName)\n      throw new Error(\n        \"The field `notify` must have two properties: `principalId` and `methodName`\",\n      )\n    if (!config.notify.principalId)\n      throw new Error(\n        \"The field `notify` requires a field called `principalId`\",\n      )\n    if (typeof config.notify.principalId !== \"string\")\n      throw new Error(\"The field `notify.principalId` must be of type 'string'\")\n    if (!config.notify.methodName)\n      throw new Error(\"The field `notify` requires a field called `methodName`\")\n    if (typeof config.notify.methodName !== \"string\")\n      throw new Error(\"The field `notify.methodName` must be of type 'string'\")\n    if (!ALLOWED_AUTH_PROVIDERS.includes(config.authProvider))\n      throw new Error(\n        \"The field `authProvider` must be one of: \" +\n          ALLOWED_AUTH_PROVIDERS.join(\", \"),\n      )\n  }\n\n  /**\n   * A BasketItem is used to display the checkout confirmation to\n   * the user on the Quark-side and to calculate the total sum of\n   * the transaction.\n   *\n   * @typedef {Object} BasketItem\n   * @property {string} name the metadata item name. e.g. \"Spoon\"\n   * @property {string} [description] An optional item description\n   * @property {number} value the value of the metadata item as an\n   * e8s value. e.g. 10000000 for 1 ICP\n   * @property {string} valueType The currency used for the checkout.\n   * e.g. \"ICP\"\n   */\n\n  /**\n   * validateBasket -Utility Function to ensure a correct\n   * implementation of quark.js' metadata.\n   *\n   * @param {Array.<BasketItem>} metadata Array with BasketItems\n   * @returns {boolean} the validation result\n   */\n  function validateBasket(basket = []) {\n    if (!Array.isArray(basket)) {\n      throw new Error(\"The field `basket` must be an array\")\n    }\n    if (!basket.length) {\n      throw new Error(\"You should provide at least one item to check-out\")\n    }\n    const hasValidMetadata = basket.every(item => {\n      if (!item.name) throw new Error(\"The field `name` is required\")\n      if (!item.value) throw new Error(\"The field `value` is required\")\n      if (!item.valueType) throw new Error(\"The field `valueType` is required\")\n      if (typeof item.name !== \"string\")\n        throw new Error(\"The field `name` must be of type 'string'\")\n      if (typeof item.value !== \"number\")\n        throw new Error(\"The field `value` must be of type 'number'\")\n      if (typeof item.valueType !== \"string\")\n        throw new Error(\"The field `valueType` must be of type 'string'\")\n      if (!ALLOWED_VALUE_TYPES.includes(\"ICP\"))\n        throw new Error(\n          \"The field `valueType` must be one of: \" +\n            ALLOWED_VALUE_TYPES.join(\", \"),\n        )\n      if (item.description && typeof item.description !== \"string\") {\n        throw new Error(\"The field `description` must be of type 'string'\")\n      }\n      return true\n    })\n    const total = getTotal(basket)\n    const hasValidAmount = total >= 0\n    return hasValidMetadata && hasValidAmount\n  }\n\n  /**\n   * checkout - Open Quark website to confirm checkout\n   *\n   * After quark.js is properly configured, the merchant\n   * can call this Function to open a new browser window to\n   * the Quark website to let the user confirm the transfer.\n   *\n   * @param {Object} data\n   * @returns {void}\n   */\n  function checkout(data) {\n    if (!validateBasket(data)) return\n    metadata = data\n    const queryString = JSON.stringify({\n      origin: window.origin,\n      authProvider: config.authProvider,\n    })\n    quarkWindow = window.open(\n      `${config.domain}/checkout?checkoutData=${btoa(queryString)}`,\n      \"_blank\",\n    )\n  }\n\n  return {\n    checkout,\n  }\n}\n\nexport { init }\n"],"names":["quarkWindow","basket","ALLOWED_AUTH_PROVIDERS","ALLOWED_VALUE_TYPES","init","config","validateBasket","Array","isArray","Error","length","hasValidMetadata","every","item","name","value","valueType","includes","join","description","total","forEach","v","Number","getTotal","payee","domain","notify","authProvider","principalId","methodName","validateConfig","window","addEventListener","event","origin","eventData","JSON","parse","data","type","message","stringify","_key","postMessage","callback","checkout","metadata","queryString","open","btoa"],"mappings":"AAAA,IAAIA,EACAC,EAAS,GACb,MAAMC,EAAyB,CAAC,MAC1BC,EAAsB,CAAC,OAoEvBC,EAAOC,IAuGX,SAASC,EAAeL,EAAS,IAC/B,IAAKM,MAAMC,QAAQP,GACjB,MAAM,IAAIQ,MAAM,uCAElB,IAAKR,EAAOS,OACV,MAAM,IAAID,MAAM,qDAElB,MAAME,EAAmBV,EAAOW,OAAMC,IACpC,IAAKA,EAAKC,KAAM,MAAM,IAAIL,MAAM,gCAChC,IAAKI,EAAKE,MAAO,MAAM,IAAIN,MAAM,iCACjC,IAAKI,EAAKG,UAAW,MAAM,IAAIP,MAAM,qCACrC,GAAyB,iBAAdI,EAAKC,KACd,MAAM,IAAIL,MAAM,6CAClB,GAA0B,iBAAfI,EAAKE,MACd,MAAM,IAAIN,MAAM,8CAClB,GAA8B,iBAAnBI,EAAKG,UACd,MAAM,IAAIP,MAAM,kDAClB,IAAKN,EAAoBc,SAAS,OAChC,MAAM,IAAIR,MACR,yCACEN,EAAoBe,KAAK,OAE/B,GAAIL,EAAKM,aAA2C,iBAArBN,EAAKM,YAClC,MAAM,IAAIV,MAAM,oDAElB,OAAO,KAEHW,EA/FR,SAAkBnB,EAAS,IACzB,IAAImB,EAAQ,EAEZ,OADAnB,EAAOoB,SAAQC,GAAMF,GAASG,OAAOD,EAAEP,SAChCK,EA4FOI,CAASvB,GAEvB,OAAOU,GADgBS,GAAS,EA2BlC,OA/GA,SAAwBf,GACtB,IAAKA,EAAOoB,MAAO,MAAM,IAAIhB,MAAM,iCACnC,IAAKJ,EAAOqB,OAAQ,MAAM,IAAIjB,MAAM,kCACpC,IAAKJ,EAAOsB,OAAQ,MAAM,IAAIlB,MAAM,kCACpC,IAAKJ,EAAOuB,aACV,MAAM,IAAInB,MAAM,wCAClB,GAA4B,iBAAjBJ,EAAOoB,MAChB,MAAM,IAAIhB,MAAM,8CAClB,GAA6B,iBAAlBJ,EAAOqB,OAChB,MAAM,IAAIjB,MAAM,+CAClB,GAAmC,iBAAxBJ,EAAOuB,aAChB,MAAM,IAAInB,MAAM,qDAClB,GAA6B,iBAAlBJ,EAAOsB,OAChB,MAAM,IAAIlB,MAAM,+CAClB,IAAKJ,EAAOsB,OAAOE,cAAgBxB,EAAOsB,OAAOG,WAC/C,MAAM,IAAIrB,MACR,+EAEJ,IAAKJ,EAAOsB,OAAOE,YACjB,MAAM,IAAIpB,MACR,4DAEJ,GAAyC,iBAA9BJ,EAAOsB,OAAOE,YACvB,MAAM,IAAIpB,MAAM,2DAClB,IAAKJ,EAAOsB,OAAOG,WACjB,MAAM,IAAIrB,MAAM,2DAClB,GAAwC,iBAA7BJ,EAAOsB,OAAOG,WACvB,MAAM,IAAIrB,MAAM,0DAClB,IAAKP,EAAuBe,SAASZ,EAAOuB,cAC1C,MAAM,IAAInB,MACR,4CACEP,EAAuBgB,KAAK,OA7EpCa,CAAe1B,GACf2B,OAAOC,iBACL,WACA,SAAUC,GACR,GAAIA,EAAMC,SAAW9B,EAAOqB,OAAQ,OACpC,MAAMU,EAAYC,KAAKC,MAAMJ,EAAMK,MACnC,GAAK,CAAC,iBAAkB,oBAAoBtB,SAASmB,EAAUI,MAE/D,GAAuB,mBAAnBJ,EAAUI,KAA2B,CACvC,MAAMC,EAAUJ,KAAKK,UACnB,CACEF,KAAM,eACNvC,OAAAA,EACAkC,OAAAA,OACAR,OAAQtB,EAAOsB,OACfF,MAAOpB,EAAOoB,MACdG,aAAcvB,EAAOuB,eAEvB,CAACe,EAAM5B,IAA4B,iBAAVA,EAAqBQ,OAAOR,GAASA,IAEhEf,EAAY4C,YAAYH,EAASpC,EAAOqB,aAExCrB,EAAOwC,SAAST,MAGpB,GAoIK,CACLU,SAdF,SAAkBP,GAChB,IAAKjC,EAAeiC,GAAO,OAC3BQ,SAAWR,EACX,MAAMS,EAAcX,KAAKK,UAAU,CACjCP,OAAQH,OAAOG,OACfP,aAAcvB,EAAOuB,eAEvB5B,EAAcgC,OAAOiB,KACnB,GAAG5C,EAAOqB,gCAAgCwB,KAAKF,KAC/C"}